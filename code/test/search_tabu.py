
import _setup
from nose.tools import *

import dataset
import solution
import search
import judge

database = dataset.Database.from_id(1)
def test_one_iteration():
    # create initial solution
    init_solution = solution.Solution(database, schedule=[
        (6, 3, 3, 1), (6, 1, 5, 1), (10, 0, 1, 1), (6, 3, 0, 1), (5, 2, 0, 1),
        (6, 2, 1, 1), (10, 2, 2, 1), (6, 3, 1, 1), (10, 2, 3, 1), (23, 3, 4, 3),
        (6, 3, 4, 1), (27, 3, 1, 4), (21, 4, 2, 3), (23, 2, 2, 3),
        (12, 3, 0, 4), (25, 0, 0, 2), (24, 3, 4, 2), (26, 3, 3, 4),
        (11, 3, 5, 3), (27, 0, 1, 2), (26, 4, 2, 2), (27, 3, 5, 0),
        (27, 4, 4, 2), (24, 3, 2, 2), (21, 2, 1, 5), (12, 2, 5, 4),
        (21, 2, 4, 2), (11, 4, 0, 3), (24, 0, 2, 2), (26, 0, 1, 3),
        (12, 4, 1, 1), (26, 0, 3, 2), (12, 4, 2, 1), (12, 0, 4, 2),
        (14, 0, 5, 3), (13, 2, 3, 3), (14, 2, 2, 5), (14, 3, 1, 5),
        (14, 1, 3, 3), (14, 1, 4, 3), (26, 4, 1, 2), (24, 4, 0, 4),
        (26, 2, 3, 5), (22, 4, 1, 3), (24, 2, 4, 4), (14, 2, 4, 3),
        (17, 0, 0, 4), (21, 1, 2, 3), (15, 1, 0, 2), (17, 0, 1, 4),
        (15, 1, 1, 2), (22, 4, 4, 1), (21, 1, 5, 5), (22, 2, 0, 3),
        (23, 4, 0, 5), (15, 4, 1, 4), (15, 0, 2, 4), (22, 0, 4, 4),
        (17, 2, 1, 4), (22, 1, 2, 2), (15, 2, 2, 4), (17, 1, 3, 2),
        (17, 1, 4, 2), (18, 3, 4, 0), (19, 2, 4, 5), (18, 0, 3, 4),
        (19, 4, 1, 5), (18, 4, 2, 4), (20, 0, 5, 5), (18, 2, 3, 2),
        (18, 1, 3, 4), (18, 1, 4, 4), (19, 0, 0, 5), (16, 1, 5, 2),
        (19, 0, 1, 5), (16, 4, 2, 5), (23, 0, 2, 5), (25, 2, 5, 2),
        (28, 2, 5, 3), (19, 3, 5, 4), (27, 2, 1, 2), (25, 3, 5, 2),
        (16, 3, 4, 4), (16, 0, 3, 5), (28, 0, 4, 5), (20, 4, 3, 3),
        (25, 1, 0, 5), (16, 3, 3, 2), (25, 1, 1, 5), (20, 3, 2, 3),
        (25, 1, 2, 5), (28, 3, 3, 3), (20, 4, 4, 3), (20, 1, 3, 5),
        (20, 1, 4, 5), (22, 0, 5, 2), (23, 2, 3, 4), (27, 3, 0, 2),
        (17, 4, 0, 2), (11, 1, 2, 4), (23, 0, 3, 3), (21, 3, 1, 2),
        (11, 3, 0, 3), (11, 0, 4, 3), (7, 0, 2, 1), (5, 2, 4, 1), (7, 2, 5, 1),
        (5, 0, 3, 1), (5, 0, 4, 1), (5, 0, 5, 1), (10, 1, 0, 1), (5, 3, 2, 1),
        (5, 1, 1, 1), (5, 1, 2, 1), (2, 2, 4, 0), (2, 2, 5, 0), (2, 1, 3, 0),
        (1, 3, 0, 0), (3, 1, 4, 0), (1, 3, 1, 0), (8, 1, 5, 0), (1, 4, 0, 0),
        (0, 0, 2, 0), (0, 0, 3, 0), (0, 0, 4, 0), (0, 0, 5, 0), (8, 0, 0, 0),
        (3, 4, 1, 0), (8, 4, 2, 0), (8, 4, 3, 0), (9, 4, 4, 0), (1, 3, 2, 0),
        (2, 1, 0, 0), (0, 2, 0, 0), (1, 0, 1, 0), (2, 1, 1, 0), (0, 2, 1, 0),
        (2, 1, 2, 0), (1, 2, 2, 0), (3, 2, 3, 0), (2, 3, 3, 0), (6, 3, 5, 1),
        (4, 1, 3, 1), (9, 1, 4, 1), (28, 4, 5, 3), (10, 4, 5, 1), (29, 4, 5, 2)
    ])
    assert_equal(init_solution.objective, 223)

    # perform tabu search
    tabu = search.TABU(database, init_solution, allow_swap='always')
    tabu.search(0.0001)

    # Validate solution
    v = judge.Validator(database, tabu.solution)
    assert_equal(v.valid, True)
    assert_equal(v.correct, True)

    # assert new solution
    assert_equal(tabu.iterations, 1)
    assert_equal(tabu.solution.objective, 211)
    assert_equal(tabu.solution.export(), [
        (28, 2, 5, 3), (27, 3, 1, 4), (27, 3, 5, 0), (27, 4, 4, 2),
        (28, 0, 4, 5), (28, 3, 3, 3), (27, 0, 1, 2), (26, 4, 2, 2),
        (26, 3, 3, 4), (26, 4, 1, 2), (26, 0, 1, 3), (26, 0, 3, 2),
        (26, 2, 3, 5), (27, 2, 1, 2), (25, 2, 5, 2), (25, 3, 5, 2),
        (25, 0, 0, 2), (24, 3, 4, 2), (24, 3, 2, 2), (24, 4, 0, 4),
        (24, 0, 2, 2), (24, 2, 4, 4), (23, 3, 4, 3), (23, 4, 0, 5),
        (25, 1, 0, 5), (25, 1, 1, 5), (25, 1, 2, 5), (23, 2, 2, 3),
        (23, 2, 3, 4), (27, 3, 0, 2), (22, 4, 1, 3), (22, 4, 4, 1),
        (22, 2, 0, 3), (22, 1, 2, 2), (23, 0, 2, 5), (21, 4, 2, 3),
        (22, 0, 4, 4), (22, 0, 5, 2), (23, 0, 3, 3), (21, 2, 1, 5),
        (21, 2, 4, 2), (21, 1, 2, 3), (21, 1, 5, 5), (20, 4, 3, 3),
        (20, 3, 2, 3), (20, 4, 4, 3), (19, 4, 1, 5), (20, 0, 5, 5),
        (19, 2, 4, 5), (18, 3, 4, 0), (18, 4, 2, 4), (18, 2, 3, 2),
        (18, 0, 3, 4), (18, 1, 3, 4), (18, 1, 4, 4), (19, 0, 0, 5),
        (19, 0, 1, 5), (19, 3, 5, 4), (20, 1, 3, 5), (20, 1, 4, 5),
        (17, 2, 1, 4), (17, 0, 0, 4), (17, 0, 1, 4), (17, 1, 3, 2),
        (17, 1, 4, 2), (16, 4, 2, 5), (16, 3, 4, 4), (16, 1, 5, 2),
        (15, 4, 1, 4), (15, 1, 0, 2), (15, 1, 1, 2), (14, 3, 1, 5),
        (14, 2, 2, 5), (14, 0, 5, 3), (12, 3, 0, 4), (12, 2, 5, 4),
        (12, 4, 1, 1), (12, 4, 2, 1), (11, 3, 5, 3), (11, 4, 0, 3),
        (12, 0, 4, 2), (13, 2, 3, 3), (14, 1, 3, 3), (14, 1, 4, 3),
        (14, 2, 4, 3), (15, 0, 2, 4), (15, 2, 2, 4), (16, 0, 3, 5),
        (16, 3, 3, 2), (17, 4, 0, 2), (21, 3, 1, 2), (11, 1, 2, 4),
        (11, 3, 0, 3), (11, 0, 4, 3), (28, 4, 5, 3), (10, 2, 2, 1),
        (10, 2, 3, 1), (10, 0, 1, 1), (10, 1, 0, 1), (9, 4, 4, 0),
        (8, 1, 5, 0), (7, 0, 2, 1), (7, 2, 5, 1), (8, 0, 0, 0), (8, 4, 2, 0),
        (8, 4, 3, 0), (6, 3, 3, 1), (6, 3, 0, 1), (6, 1, 5, 1), (6, 2, 1, 1),
        (6, 3, 1, 1), (6, 3, 4, 1), (5, 2, 0, 1), (5, 2, 4, 1), (5, 3, 2, 1),
        (5, 0, 3, 1), (5, 0, 4, 1), (5, 0, 5, 1), (5, 1, 1, 1), (5, 1, 2, 1),
        (6, 3, 5, 1), (3, 4, 1, 0), (3, 1, 4, 0), (3, 2, 3, 0), (2, 2, 4, 0),
        (2, 2, 5, 0), (2, 1, 3, 0), (1, 4, 0, 0), (1, 3, 0, 0), (1, 3, 1, 0),
        (1, 3, 2, 0), (2, 1, 0, 0), (2, 1, 1, 0), (2, 1, 2, 0), (1, 0, 1, 0),
        (0, 0, 2, 0), (0, 0, 3, 0), (0, 0, 4, 0), (0, 0, 5, 0), (0, 2, 0, 0),
        (0, 2, 1, 0), (1, 2, 2, 0), (2, 3, 3, 0), (4, 1, 3, 1), (9, 1, 4, 1),
        (10, 4, 5, 1), (29, 4, 5, 2), (29, 1, 1, 3)
    ])
